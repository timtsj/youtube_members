<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.8;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
<h3>Регистрация участника</h3>

<div class="form-group">
    <label>ID пользователя</label>
    <input
        type="text"
        id="chat_id"
        placeholder="Только цифры"
        inputmode="numeric"
    >
</div>

<div class="form-group">
    <label>Логин (необязательно)</label>
    <input type="text" id="username" placeholder="@username">
</div>

<div class="form-group">
    <label>Номер телефона</label>
    <input
        type="tel"
        id="phone"
        placeholder="+77001234567"
        inputmode="tel"
    >
</div>

<div class="form-group">
    <label>Сумма (общее)</label>
    <input
        type="text"
        id="amount"
        placeholder="Только цифры"
        inputmode="numeric"
    >
</div>

<div class="form-group">
    <label>Дата вступления</label>
    <input type="date" id="start_date">
</div>

<div class="form-group">
    <label>Срок доступа (мес.)</label>
    <select id="months">
        <option value="1">1 месяц</option>
        <option value="3">3 месяца</option>
        <option value="6">6 месяцев</option>
        <option value="12">12 месяцев</option>
    </select>
</div>

<button id="submitBtn" onclick="sendData()">
    <span class="btn-text">Добавить в группу</span>
    <span class="loader" hidden></span>
</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const $ = id => document.getElementById(id);

    $('start_date').value = new Date().toISOString().slice(0, 10);

    // === ID: только цифры ===
    $('chat_id').addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    // === Телефон: только + и цифры, + только в начале ===
    $('phone').addEventListener('input', e => {
        let v = e.target.value;

        // удаляем всё кроме цифр и +
        v = v.replace(/[^0-9+]/g, '');

        // если + не в начале — убираем
        if (v.includes('+') && !v.startsWith('+')) {
            v = '+' + v.replace(/\+/g, '');
        }

        // оставляем только один +
        v = v.replace(/\+(?=.)/g, '+').replace(/\++/g, '+');

        e.target.value = v;
    });

    // === Сумма: только цифры ===
    $('amount').addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    const btn = $('submitBtn');
    const btnText = btn.querySelector('.btn-text');
    const loader = btn.querySelector('.loader');

    function setLoading(state) {
        btn.disabled = state;
        btnText.hidden = state;
        loader.hidden = !state;
    }

    function notifySuccess(message = 'Данные сохранены') {
        setLoading(false);
        alert(message);
        setTimeout(() => tg.close(), 300);
    }

    async function post(url, payload, timeout = 6000) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeout);

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal: controller.signal
            });

            clearTimeout(timer);

            if (!res.ok) throw new Error(`HTTP ${res.status}`);
        } finally {
            clearTimeout(timer);
        }
    }

    async function sendData() {
        if (btn.disabled) return;

        let chatId = $('chat_id').value.trim();
        let username = $('username').value.trim();
        let phone = $('phone').value.trim();
        let amount = $('amount').value.trim();

        if (!chatId) {
            alert('ID пользователя обязателен');
            return;
        }

        if (username && !username.startsWith('@')) {
            username = '@' + username;
            $('username').value = username;
        }

        setLoading(true);

        const payload = {
            chat_id: chatId,
            username: username || null,
            phone: phone || null,
            amount: amount ? Number(amount) : null,
            start_date: $('start_date').value,
            months: $('months').value
        };

        try {
            await post(
                'https://n8nprivate.duckdns.org/webhook/registration',
                payload
            );
            notifySuccess();
        } catch (e) {
            setLoading(false);
            alert('Ошибка связи с n8n');
            console.error(e);
        }
    }
</script>
</body>
</html>
